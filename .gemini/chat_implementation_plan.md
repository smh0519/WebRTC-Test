# 📌 채팅 기능 구현 기획서

## 🎯 목표
통화방에 **실시간 채팅 기능** 추가 - 화이트보드처럼 토글 방식으로 동작

---

## 📝 요구사항

### 기본 기능
- [ ] 화면 하단 버튼 클릭 시 채팅 패널 표시/숨김
- [ ] 실시간 메시지 송수신 (LiveKit DataChannel 활용)
- [ ] 메시지에 발신자 닉네임 표시
- [ ] 새 메시지 도착 시 알림 (버튼에 뱃지)
- [ ] 메시지 자동 스크롤 (최신 메시지로)

### UI/UX
- [ ] 채팅 패널: 오른쪽 사이드 슬라이드 또는 하단 팝업
- [ ] 입력창 + 전송 버튼
- [ ] 내 메시지 / 상대 메시지 스타일 구분
- [ ] 채팅 열기 버튼 (화이트보드 버튼 옆)
- [ ] 읽지 않은 메시지 수 뱃지

---

## 🏗️ 기술 설계

### 1. 메시지 데이터 구조

```typescript
interface ChatMessage {
  type: 'chat';
  id: string;          // 메시지 고유 ID
  sender: string;      // 발신자 닉네임
  content: string;     // 메시지 내용
  timestamp: number;   // 전송 시간
}
```

### 2. 통신 방식

**LiveKit DataChannel** 사용 (화이트보드와 동일)

```typescript
// 메시지 전송
room.localParticipant.publishData(
  new TextEncoder().encode(JSON.stringify(message)),
  { reliable: true }  // 채팅은 reliable 모드 (손실 방지)
);

// 메시지 수신
room.on(RoomEvent.DataReceived, (payload, participant) => {
  const message = JSON.parse(new TextDecoder().decode(payload));
  if (message.type === 'chat') {
    // 채팅 메시지 처리
  }
});
```

### 3. 컴포넌트 구조

```
frontend/src/components/
├── ChatPanel.tsx        # 채팅 패널 (메인 컴포넌트)
├── ChatMessage.tsx      # 개별 메시지 아이템
└── ChatInput.tsx        # 메시지 입력창
```

---

## 📁 파일 변경 목록

### 새로 생성
| 파일 | 설명 |
|------|------|
| `components/ChatPanel.tsx` | 채팅 패널 메인 컴포넌트 |
| `components/ChatMessage.tsx` | 메시지 말풍선 컴포넌트 |
| `components/ChatInput.tsx` | 입력창 컴포넌트 |

### 수정
| 파일 | 변경 내용 |
|------|----------|
| `app/room/[roomId]/page.tsx` | 채팅 상태 추가, 토글 버튼 추가, ChatPanel 렌더링 |

---

## 🎨 UI 디자인

### 채팅 버튼 (하단 우측, 화이트보드 버튼 옆)
```
┌──────┐ ┌──────┐
│ 📝  │ │ 💬 3 │  ← 읽지 않은 메시지 수 뱃지
└──────┘ └──────┘
화이트보드  채팅
```

### 채팅 패널 (오른쪽 슬라이드)
```
┌─────────────────────────────┬────────────────┐
│                             │  💬 채팅       │
│      영상 통화 영역          │ ────────────── │
│                             │ 민혁: 안녕!     │
│                             │ 나: 반가워 👋   │
│                             │ 민혁: ㅋㅋㅋ    │
│                             │ ────────────── │
│                             │ [입력창] [전송] │
└─────────────────────────────┴────────────────┘
```

### 메시지 스타일

**내 메시지 (오른쪽 정렬, 보라색)**
```
                    ┌─────────────────┐
                    │ 안녕하세요! 👋   │
                    └─────────────────┘
                              14:32
```

**상대 메시지 (왼쪽 정렬, 회색)**
```
민혁
┌─────────────────┐
│ 반갑습니다~      │
└─────────────────┘
14:33
```

---

## 📋 구현 순서

### Phase 1: 기본 구조 (30분)
1. `ChatPanel.tsx` 기본 레이아웃 생성
2. `page.tsx`에 채팅 상태 및 토글 버튼 추가
3. 채팅 패널 열기/닫기 동작 확인

### Phase 2: 메시지 송수신 (30분)
4. LiveKit DataChannel 연결
5. 메시지 전송 기능 구현
6. 메시지 수신 및 표시 기능 구현

### Phase 3: UI 완성 (30분)
7. `ChatMessage.tsx` 말풍선 스타일링
8. 자동 스크롤 구현
9. 읽지 않은 메시지 뱃지 추가

### Phase 4: 마무리 (15분)
10. 애니메이션 추가 (슬라이드 인/아웃)
11. 반응형 디자인 확인
12. 테스트 및 버그 수정

---

## ⚠️ 고려사항

### 성능
- 메시지가 많아지면 가상 스크롤 고려
- 메모리 관리를 위해 오래된 메시지 정리

### 데이터 동기화
- 화이트보드 데이터와 채팅 데이터 구분 (`type` 필드)
- 메시지 순서 보장 (`reliable: true`)

### 사용성
- 채팅이 열려있어도 영상통화 계속 표시
- Enter 키로 메시지 전송
- Shift+Enter로 줄바꿈

---

## 🔄 화이트보드와의 차이점

| 항목 | 화이트보드 | 채팅 |
|------|-----------|------|
| 모드 | 전체화면 (영상 숨김) | 사이드 패널 (영상 유지) |
| 데이터 | 드로잉 좌표 | 텍스트 메시지 |
| 신뢰성 | unreliable (빠름) | reliable (안정) |
| 저장 | 서버 저장 | 클라이언트만 |

---

## ✅ 완료 체크리스트

- [ ] 채팅 버튼 추가
- [ ] 채팅 패널 토글 동작
- [ ] 메시지 입력 및 전송
- [ ] 실시간 메시지 수신
- [ ] 메시지 UI 스타일링
- [ ] 자동 스크롤
- [ ] 읽지 않은 메시지 뱃지
- [ ] 애니메이션
- [ ] 테스트 완료

---

**예상 소요 시간: 약 2시간**

구현 시작할까요? 🚀
